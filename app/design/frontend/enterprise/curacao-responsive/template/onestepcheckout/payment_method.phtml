<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * One page checkout payment methods
 *
 * @see Mage_Checkout_Block_Onepage_Payment_Methods
 */
?>


<?php

$helper = Mage::helper('onestepcheckout/checkout');
$hide_nonfree_methods = false;
if($helper->settings['hide_nonfree_payment_methods'])   {
    foreach($this->getMethods() as $_method)    {
        if($_method->getCode() == 'free')   {
            $hide_nonfree_methods = true;
        }
    }
}
$Data = Mage::getSingleton('core/session')->getCuracacaodp();
$_storeId = Mage::app()->getStore()->getId();
	if($_storeId == 1){
		$required = 'Required Fields';
		$remove = 'Undo';
		$available = 'available credit is <strong>$</strong>';
		$charge = ' will be charged to this account ';
	}else{
		$required = "Campos Requeridos";
		$remove = "	cancelar";
		$available = 'crédito disponible : <strong>$</strong>';
		$charge = ' se agregará a su cuenta ';
	}
?>

<div class="one_step_payment-methods">
<script type="text/javascript">
//<![CDATA[
  <?php echo $this->getChildHtml('reward.scripts'); ?>
  <?php echo $this->getChildHtml('customerbalance_scripts'); ?>
  var payment = new Payment('checkout-payment-method-load', '<?php echo $this->getUrl('checkout/onepage/savePayment') ?>');
  payment.currentMethod = "<?php echo $this->getQuote()->getPayment()->getMethod() ?>";
//]]>
</script>
    <?php if(Mage::helper('onestepcheckout')->isEnterprise()):?>
        <?php echo $this->getChildHtml('customerbalance'); ?>
        <?php echo $this->getChildHtml('reward.points'); ?>
    <?php endif;?>

    <?php if (count($this->getMethods())=='1' && Mage::getStoreConfig('onestepcheckout/general/hide_payment_method')):?>
    <dl id="checkout-payment-method-load" style="display: none">
        <?php foreach ($this->getMethods() as $_method): $_code = $_method->getCode() ?>
		
        <dt>
        <input id="p_method_<?php echo $_code ?>" value="<?php echo $_code ?>" type="hidden" name="payment[method]" title="<?php echo $this->htmlEscape($_method->getTitle()) ?>" class="radio" />
        <label for="p_method_<?php echo $_code ?>"><?php echo $_method->getTitle() ?></label></dt>
        <?php endforeach; ?>
    </dl>
    <?php else:?>
		
        <dl id="checkout-payment-method-load">
        <?php foreach ($this->getMethods() as $_method): $_code = $_method->getCode() ?>
        <?php if($hide_nonfree_methods && $_code != 'free') continue; ?>
        	
            <div class="payment-methods">
            
            <dt>
            <?php if( sizeof($this->getMethods()) > 1 ): ?>
            <?php if($Data!=''){?>
             	<input id="p_method_<?php echo $_code ?>" <?php if($_code=='pay'){?> disabled="disabled"<?php }?>  value="<?php echo $_code ?>" type="radio" name="payment[method]" title="<?php echo $this->htmlEscape($_method->getTitle()) ?>" class="radio validate-one-required-by-name" />
            <?php }else{?>
                <input id="p_method_<?php echo $_code ?>" value="<?php echo $_code ?>" type="radio" name="payment[method]" title="<?php echo $this->htmlEscape($_method->getTitle()) ?>" class="radio validate-one-required-by-name"  />
                <?php }?>
            <?php else: ?>
                <span class="no-display"><input id="p_method_<?php echo $_code ?>" value="<?php echo $_code ?>" type="radio" name="payment[method]" checked="checked" /></span>
            <?php endif; ?>
            	<?php if($_code=='pay'||$_code=='verisign'){?>
                <div id="payment_label"><label for="p_method_<?php echo $_code ?>"><?php echo $_method->getTitle() ?></label></div>
                <div id="payment_icons">
                <?php if($_code=='pay'){?>
					<img src="/images/apache_pb2.png" /> 
                    
                    <?php 
						if ($this->helper('customer')->isLoggedIn() ) {
							$session = Mage::getSingleton('customer/session', array('name'=>'frontend')); 
							$customer_data = Mage::getModel('customer/customer')->load($session->id);
							if($customer_data->isauthenticate){
								if(Mage::getSingleton('core/session')->getCustbalance()){
									$balance = Mage::getSingleton('core/session')->getCustbalance();	
								}else{
									$balance = file_get_contents('http://108.171.160.207/custom/getbalance.php?custnum='.$customer_data->curacaocustid);
									Mage::getSingleton('core/session')->setCustbalance($balance);
								}
								 if($Data == ''){
									echo '<div id="available_payment-curacao">('.$available.'<strong>'.$balance.'</strong>)</div>';
								 }
							}
						}
					?>
                    <?php if($Data != ''){
						$charge_amt = (float)Mage::getModel('checkout/cart')->getQuote()->getGrandTotal()-$Data;
						?>
                    	<?php echo '<div id="available_payment-curacao"><span><strong>$'.number_format((float)$charge_amt, 2, '.', '').'</strong>'.$charge ?></span> | <a href="#" onclick="return remove_curacao()"><?php echo $remove;?></a></div>
                    <?php }?>
				<?php }elseif($_code=='verisign'){?>
					<img src="/images/credit_card.png" />
                    <?php if($Data != ''){
						?>
                    	<?php echo '<div id="available_payment"><span><strong>$'.number_format((float)$Data, 2, '.', '').'</strong>'.$charge.'</span></div>'?>
                    <?php }?>
				<?php }?>
                </div>
                
                <div style="clear:both"></div>
                <?php }?>
            </dt>
            <?php if($html = $this->getChildHtml('payment.method.'.$_code)): ?>
            <dd id="container_payment_method_<?php echo $_code; ?>" class="payment-method" style="display:none">
                <?php echo $html; ?>
                <div id="req_field"><em>*</em> <?php echo $required;?></div>
            </dd>
            
            <?php endif; ?>
           
        <?php endforeach; ?>
        </dl>
    <?php endif;?>
</div>
<script type="text/javascript">
//<![CDATA[

$$('.cvv-what-is-this').each(function(element){
    Event.observe(element, 'click', toggleToolTip);
});

function toggleToolTip(event){
    if($('payment-tool-tip')){
        $('payment-tool-tip').setStyle({
            left: (Event.pointerX(event)-100)+'px',
            top: (Event.pointerY(event)-300)+'px'
        });
        $('payment-tool-tip').toggle();
    }
    Event.stop(event);
}

var checkout = new Checkout();
$$('#checkout-payment-method-load dt input').invoke('observe', 'click', function(e) {

    var element = e.element();
    var name = 'payment_form_' + element.getValue();
    payment.currentMethod = element.getValue();
    /* Hide all other forms */
    $$('dd.payment-method').invoke('hide');

    if(element.checked) {
        payment.switchMethod(payment.currentMethod);
        var form = $(name);
        var container = $('container_payment_method_' + element.getValue());

        if(element !== null && container !== null)    {
            container.show();
            $(name).show();
        }
    }
});

<?php if(Mage::helper('onestepcheckout')->isEnterprise() && Mage::helper('customer')->isLoggedIn()):?>
//if we have a enterprise version we should include this

rPoints = $('use_reward_points');
if(rPoints){
    if(rPoints.checked){
        payment.switchRewardPointsCheckbox();
    }
}
cBalance = $('use_customer_balance');
if(cBalance){
    if(cBalance.checked){
        payment.switchCustomerBalanceCheckbox();
    }
}
//if we have a enterprise version we should include this end
<?php endif;?>

payment.switchMethod(payment.currentMethod);
<?php echo $this->getChildHtml('giftcardaccount_scripts');?>
//]]>
</script>

<script type="text/javascript">
	function remove_curacao(){
		// Confirm popup if needed
		/*var answer = confirm('Are you sure you want to remove this option?');
		if (answer)
		{
		  alert("Yes");
		}
		else
		{
		  alert("cancle")
		}
		return false;*/
		jQuery(".onestepcheckout-summary").html(' <div id="summery-loading"><center><img src="/images/gray_fade_small.gif" /></center></div>');
		var login_url = '/onestepcheckout/ajax/removedp/'
		jQuery.ajax({ 
				type: 'post',
				data: {'downpayment':1},
				url:  login_url,                    
				success: function(data) {
			   
						window.location = '/onestepcheckout/';
					
				}.bind(this)
	     });
		return false;
	}
</script>